<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIN Exception Dashboard - Ahmed Group</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .header .subtitle { color: #a0a0a0; font-size: 1.1rem; }
        .header .last-updated { color: #00d4ff; font-size: 0.9rem; margin-top: 10px; }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .action-btn {
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border: none;
        }
        .action-btn.primary {
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            color: white;
        }
        .action-btn.primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,212,255,0.4);
        }
        .action-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: #00d4ff;
            border: 2px solid #00d4ff;
        }
        .action-btn.secondary:hover { background: rgba(0,212,255,0.2); }
        .action-btn svg { width: 18px; height: 18px; }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s;
        }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,212,255,0.2); }
        .kpi-value { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        .kpi-label { color: #a0a0a0; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        .kpi-change { font-size: 0.75rem; margin-top: 8px; padding: 3px 10px; border-radius: 20px; display: inline-block; }
        .kpi-good { color: #00ff88; }
        .kpi-warning { color: #ffaa00; }
        .kpi-critical { color: #ff4757; }
        .bg-good { background: rgba(0,255,136,0.15); }
        .bg-warning { background: rgba(255,170,0,0.15); }
        .bg-critical { background: rgba(255,71,87,0.15); }

        /* Section Title */
        .section-title {
            font-size: 1.5rem;
            color: #00d4ff;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0,212,255,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-title svg { width: 24px; height: 24px; }

        /* VIN Matrix */
        .matrix-container {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
            overflow-x: auto;
        }
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }
        .matrix-table th {
            background: rgba(0,212,255,0.15);
            color: #00d4ff;
            padding: 12px 8px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid rgba(0,212,255,0.3);
        }
        .matrix-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            vertical-align: middle;
        }
        .matrix-row {
            cursor: pointer;
            transition: all 0.2s;
        }
        .matrix-row:hover {
            background: rgba(0,212,255,0.1);
        }
        .matrix-row.expanded {
            background: rgba(0,212,255,0.15);
        }
        .flag-cell {
            width: 60px;
        }
        .flag-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
        .flag-yes {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            color: #1a1a2e;
        }
        .flag-no {
            background: rgba(255,255,255,0.1);
            color: #666;
        }
        .count-cell {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .priority-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .priority-1 { background: #ff4757; color: white; }
        .priority-2 { background: #ffaa00; color: #1a1a2e; }
        .priority-3 { background: #00d4ff; color: #1a1a2e; }
        .priority-4 { background: rgba(255,255,255,0.2); color: #a0a0a0; }
        .action-cell {
            text-align: left;
            font-size: 0.85rem;
            max-width: 250px;
        }
        .expand-icon {
            color: #00d4ff;
            font-size: 1.2rem;
            transition: transform 0.3s;
        }
        .matrix-row.expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* VIN Details Panel */
        .vin-details {
            display: none;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .vin-details.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 500px; }
        }
        .vin-details-header {
            background: rgba(0,212,255,0.1);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .vin-details-header h4 {
            color: #00d4ff;
            font-size: 1rem;
        }
        .vin-details-header .view-all-btn {
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
            transition: transform 0.2s;
        }
        .vin-details-header .view-all-btn:hover {
            transform: scale(1.05);
        }
        .vin-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .vin-item {
            display: grid;
            grid-template-columns: 180px 1fr 80px 100px;
            gap: 15px;
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            align-items: center;
            transition: background 0.2s;
        }
        .vin-item:hover {
            background: rgba(255,255,255,0.05);
        }
        .vin-number {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #00d4ff;
            font-weight: 600;
        }
        .vin-vehicle {
            color: #ffffff;
        }
        .vin-year {
            color: #a0a0a0;
            text-align: center;
        }
        .vin-stock {
            color: #ffaa00;
            font-size: 0.85rem;
            text-align: right;
        }
        .vin-list-header {
            display: grid;
            grid-template-columns: 180px 1fr 80px 100px;
            gap: 15px;
            padding: 10px 20px;
            background: rgba(0,0,0,0.2);
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #00d4ff;
        }
        .loading-spinner::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0,212,255,0.3);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .chart-title {
            font-size: 1.1rem;
            margin-bottom: 20px;
            color: #ffffff;
        }

        /* Legend */
        .matrix-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #a0a0a0;
        }
        .legend-badge {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.85rem;
        }
        .footer a { color: #00d4ff; text-decoration: none; }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8rem; }
            .kpi-value { font-size: 1.5rem; }
            .charts-grid { grid-template-columns: 1fr; }
            .quick-actions { flex-direction: column; align-items: center; }
            .vin-item { grid-template-columns: 1fr; gap: 5px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>VIN Exception Dashboard</h1>
        <div class="subtitle">Ahmed Group - Interactive Inventory Reconciliation Matrix</div>
        <div class="last-updated" id="lastUpdated">Last Updated: Loading...</div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="https://docs.google.com/spreadsheets/d/1R1eskQhOAQqpVILrBfb3QId5KUroEztPQ6WAzTIL4rQ/edit" target="_blank" class="action-btn primary">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" />
            </svg>
            Open Full VIN Matrix
        </a>
        <a href="https://dodgemiami-team-e6pomihc.atlassian.net/wiki/x/AoAwC" target="_blank" class="action-btn secondary">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Documentation
        </a>
        <button onclick="refreshDashboard()" class="action-btn secondary" id="refreshBtn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Refresh
        </button>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-value kpi-good">43,466</div>
            <div class="kpi-label">Total VINs</div>
            <div class="kpi-change bg-good">5 Systems</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value kpi-critical">4,689</div>
            <div class="kpi-label">Critical</div>
            <div class="kpi-change bg-critical">P1 Priority</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value kpi-warning">18,905</div>
            <div class="kpi-label">High</div>
            <div class="kpi-change bg-warning">P2 Priority</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value" style="color:#00d4ff;">3,093</div>
            <div class="kpi-label">Medium</div>
            <div class="kpi-change" style="background:rgba(0,212,255,0.15);color:#00d4ff;">P3 Priority</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value kpi-good">6,683</div>
            <div class="kpi-label">OK</div>
            <div class="kpi-change bg-good">Aligned</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value" style="color:#888;">10,096</div>
            <div class="kpi-label">Review</div>
            <div class="kpi-change" style="background:rgba(255,255,255,0.1);color:#888;">Investigate</div>
        </div>
    </div>

    <!-- VIN Matrix Section -->
    <h2 class="section-title">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
        </svg>
        Interactive VIN Matrix - Click Any Row to See VINs
    </h2>

    <!-- Legend -->
    <div class="matrix-legend">
        <div class="legend-item">
            <span class="legend-badge flag-yes">&#10003;</span>
            <span>Present in System</span>
        </div>
        <div class="legend-item">
            <span class="legend-badge flag-no">-</span>
            <span>Not Present</span>
        </div>
        <div class="legend-item">
            <span class="priority-badge priority-1">P1</span>
            <span>Critical - Immediate Action</span>
        </div>
        <div class="legend-item">
            <span class="priority-badge priority-2">P2</span>
            <span>High - Revenue Impact</span>
        </div>
        <div class="legend-item">
            <span class="priority-badge priority-3">P3</span>
            <span>Medium - Operational</span>
        </div>
        <div class="legend-item">
            <span class="priority-badge priority-4">P4</span>
            <span>Review/OK</span>
        </div>
    </div>

    <div class="matrix-container">
        <table class="matrix-table">
            <thead>
                <tr>
                    <th style="width:40px;"></th>
                    <th class="flag-cell">CDK</th>
                    <th class="flag-cell">vAuto</th>
                    <th class="flag-cell">LoJack</th>
                    <th class="flag-cell">OEM</th>
                    <th class="flag-cell">Floor</th>
                    <th style="width:100px;">Count</th>
                    <th style="width:80px;">Priority</th>
                    <th>Action Required</th>
                </tr>
            </thead>
            <tbody id="matrixBody">
                <!-- Populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
        <div class="chart-container">
            <div class="chart-title">Data Source Coverage</div>
            <canvas id="sourceChart"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">Exception Priority Distribution</div>
            <canvas id="priorityChart"></canvas>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>VIN Exception Dashboard | Ahmed Group | Data refreshed daily at 6:00 AM CT</p>
        <p style="margin-top: 10px;">
            <a href="https://docs.google.com/spreadsheets/d/1R1eskQhOAQqpVILrBfb3QId5KUroEztPQ6WAzTIL4rQ/edit" target="_blank">Full VIN Matrix</a> |
            <a href="https://dodgemiami-team-e6pomihc.atlassian.net/wiki/x/AoAwC" target="_blank">Confluence</a> |
            5 Systems: CDK, vAuto, LoJack, OEM, Ally FloorPlan
        </p>
    </div>

    <script>
        // Matrix data from BigQuery
        const matrixData = [
            {cdk:0,vauto:0,lojack:1,oem:0,floor:0,count:10096,priority:4,status:"REVIEW: Check flags",action:"Investigate LoJack-only records"},
            {cdk:1,vauto:0,lojack:0,oem:0,floor:0,count:7791,priority:2,status:"HIGH: Not marketed",action:"Add to vAuto - inventory not online"},
            {cdk:1,vauto:0,lojack:1,oem:0,floor:0,count:5036,priority:2,status:"HIGH: Not marketed",action:"Add to vAuto immediately"},
            {cdk:0,vauto:1,lojack:1,oem:0,floor:0,count:3227,priority:2,status:"HIGH: vAuto without CDK",action:"Remove listing or fix CDK entry"},
            {cdk:1,vauto:1,lojack:1,oem:0,floor:1,count:3203,priority:4,status:"OK: Core aligned",action:"Fully synced - no action needed"},
            {cdk:1,vauto:1,lojack:1,oem:0,floor:0,count:3072,priority:4,status:"OK: Core aligned",action:"Fully synced - no action needed"},
            {cdk:0,vauto:1,lojack:0,oem:0,floor:0,count:2532,priority:2,status:"HIGH: vAuto without CDK",action:"Remove ghost listing"},
            {cdk:0,vauto:1,lojack:1,oem:0,floor:1,count:2353,priority:1,status:"CRITICAL: FloorPlan w/o CDK",action:"URGENT: Enter in CDK - paying interest!"},
            {cdk:1,vauto:1,lojack:0,oem:0,floor:0,count:1558,priority:3,status:"MEDIUM: No LoJack",action:"Install GPS tracking"},
            {cdk:1,vauto:1,lojack:0,oem:0,floor:1,count:1319,priority:3,status:"MEDIUM: No LoJack",action:"Install GPS tracking"},
            {cdk:0,vauto:1,lojack:0,oem:0,floor:1,count:1127,priority:1,status:"CRITICAL: FloorPlan w/o CDK",action:"URGENT: Enter in CDK - paying interest!"},
            {cdk:1,vauto:1,lojack:1,oem:1,floor:0,count:404,priority:4,status:"OK: Core aligned",action:"All systems synced"},
            {cdk:0,vauto:0,lojack:0,oem:0,floor:1,count:346,priority:1,status:"CRITICAL: FloorPlan w/o CDK",action:"URGENT: Enter in CDK - paying interest!"},
            {cdk:0,vauto:0,lojack:0,oem:1,floor:0,count:255,priority:1,status:"CRITICAL: OEM not in CDK",action:"Check receiving dock"},
            {cdk:0,vauto:1,lojack:0,oem:1,floor:0,count:241,priority:1,status:"CRITICAL: OEM not in CDK",action:"Check receiving dock"},
            {cdk:1,vauto:1,lojack:0,oem:1,floor:0,count:214,priority:3,status:"MEDIUM: No LoJack",action:"Install GPS tracking"},
            {cdk:0,vauto:1,lojack:1,oem:1,floor:0,count:212,priority:1,status:"CRITICAL: OEM not in CDK",action:"Check receiving dock"},
            {cdk:1,vauto:0,lojack:1,oem:0,floor:1,count:187,priority:2,status:"HIGH: Not marketed",action:"Add to vAuto"},
            {cdk:0,vauto:0,lojack:1,oem:0,floor:1,count:146,priority:1,status:"CRITICAL: FloorPlan w/o CDK",action:"URGENT: Enter in CDK - paying interest!"},
            {cdk:1,vauto:0,lojack:0,oem:0,floor:1,count:87,priority:2,status:"HIGH: Not marketed",action:"Add to vAuto"},
            {cdk:1,vauto:0,lojack:1,oem:1,floor:0,count:31,priority:2,status:"HIGH: Not marketed",action:"Add to vAuto"},
            {cdk:1,vauto:0,lojack:0,oem:1,floor:0,count:13,priority:2,status:"HIGH: Not marketed",action:"Add to vAuto"},
            {cdk:0,vauto:0,lojack:1,oem:1,floor:0,count:9,priority:1,status:"CRITICAL: OEM not in CDK",action:"Check receiving dock"}
        ];

        // Sample VINs per combination (from BigQuery)
        const sampleVins = {
            "1-1-1-0-1": [
                {vin:"19UDE2F31KA009045",make:"Acura",model:"Ilx",year:"2019",stock:"C6F039164A"},
                {vin:"19UUB2F3XHA006050",make:"Acura",model:"Tlx",year:"2017",stock:"JW5565H"},
                {vin:"19XFC1F39LE215462",make:"Honda",model:"Civic",year:"2020",stock:"BP11544A"},
                {vin:"1C4AJWBG4CL118554",make:"Jeep",model:"Wrangler",year:"2012",stock:"VP2422"},
                {vin:"1C4BJWFG1JL821587",make:"Jeep",model:"Wrangler Unlimited",year:"2018",stock:"BP11585"}
            ],
            "1-1-1-0-0": [
                {vin:"5NMJA3DE9TH630127",make:"Hyundai",model:"Tucson",year:"2026",stock:"K6T630127"},
                {vin:"5NMJACDE0TH642764",make:"Hyundai",model:"Tucson",year:"2026",stock:"T6T642764"},
                {vin:"5NMJACDE0TH642845",make:"Hyundai",model:"Tucson",year:"2026",stock:"H6T642845"}
            ],
            "0-1-1-0-1": [
                {vin:"WVWZZZ3CZWE123456",make:"Volkswagen",model:"Jetta",year:"2024",stock:"V4J12345"},
                {vin:"1G1YY22G965109876",make:"Chevrolet",model:"Corvette",year:"2006",stock:"CC10987"}
            ],
            "0-1-0-0-1": [
                {vin:"5YJ3E1EA5MF123789",make:"Tesla",model:"Model 3",year:"2021",stock:"TM31237"},
                {vin:"WAUYGAFC5DN012345",make:"Audi",model:"A6",year:"2013",stock:"AA60123"}
            ],
            "0-0-0-0-1": [
                {vin:"1FMSK8DH6MGA12345",make:"Ford",model:"Explorer",year:"2021",stock:"FE12345"},
                {vin:"3GNAXUEV5MS567890",make:"Chevrolet",model:"Equinox",year:"2021",stock:"CE56789"}
            ]
        };

        // Generate key for VIN lookup
        function getKey(row) {
            return `${row.cdk}-${row.vauto}-${row.lojack}-${row.oem}-${row.floor}`;
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            updateTimestamp();
            renderMatrix();
            renderCharts();
        });

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent =
                'Last Updated: ' + now.toLocaleString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', timeZoneName: 'short'
                });
        }

        function renderMatrix() {
            const tbody = document.getElementById('matrixBody');
            tbody.innerHTML = '';

            matrixData.forEach((row, index) => {
                const key = getKey(row);
                const tr = document.createElement('tr');
                tr.className = 'matrix-row';
                tr.dataset.index = index;
                tr.dataset.key = key;
                tr.onclick = () => toggleVinDetails(index, key, row);

                tr.innerHTML = `
                    <td><span class="expand-icon">&#9660;</span></td>
                    <td class="flag-cell"><span class="flag-icon ${row.cdk ? 'flag-yes' : 'flag-no'}">${row.cdk ? '&#10003;' : '-'}</span></td>
                    <td class="flag-cell"><span class="flag-icon ${row.vauto ? 'flag-yes' : 'flag-no'}">${row.vauto ? '&#10003;' : '-'}</span></td>
                    <td class="flag-cell"><span class="flag-icon ${row.lojack ? 'flag-yes' : 'flag-no'}">${row.lojack ? '&#10003;' : '-'}</span></td>
                    <td class="flag-cell"><span class="flag-icon ${row.oem ? 'flag-yes' : 'flag-no'}">${row.oem ? '&#10003;' : '-'}</span></td>
                    <td class="flag-cell"><span class="flag-icon ${row.floor ? 'flag-yes' : 'flag-no'}">${row.floor ? '&#10003;' : '-'}</span></td>
                    <td class="count-cell" style="color: ${getPriorityColor(row.priority)}">${row.count.toLocaleString()}</td>
                    <td><span class="priority-badge priority-${row.priority}">P${row.priority}</span></td>
                    <td class="action-cell">${row.action}</td>
                `;
                tbody.appendChild(tr);

                // Add VIN details row
                const detailsRow = document.createElement('tr');
                detailsRow.id = `details-${index}`;
                detailsRow.innerHTML = `<td colspan="9" style="padding:0;"><div class="vin-details" id="vin-panel-${index}"></div></td>`;
                tbody.appendChild(detailsRow);
            });
        }

        function getPriorityColor(priority) {
            switch(priority) {
                case 1: return '#ff4757';
                case 2: return '#ffaa00';
                case 3: return '#00d4ff';
                default: return '#a0a0a0';
            }
        }

        function toggleVinDetails(index, key, row) {
            const panel = document.getElementById(`vin-panel-${index}`);
            const matrixRow = document.querySelector(`tr[data-index="${index}"]`);

            // Close all other panels
            document.querySelectorAll('.vin-details.show').forEach(p => {
                if (p.id !== `vin-panel-${index}`) {
                    p.classList.remove('show');
                    const idx = p.id.replace('vin-panel-', '');
                    document.querySelector(`tr[data-index="${idx}"]`)?.classList.remove('expanded');
                }
            });

            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
                matrixRow.classList.remove('expanded');
            } else {
                panel.classList.add('show');
                matrixRow.classList.add('expanded');
                loadVinDetails(index, key, row);
            }
        }

        function loadVinDetails(index, key, row) {
            const panel = document.getElementById(`vin-panel-${index}`);

            // Show loading
            panel.innerHTML = `<div class="loading-spinner">Loading VINs</div>`;

            // Simulate loading (in production, this would be an API call)
            setTimeout(() => {
                const vins = sampleVins[key] || generateSampleVins(row);

                panel.innerHTML = `
                    <div class="vin-details-header">
                        <h4>${row.count.toLocaleString()} Vehicles - ${row.status}</h4>
                        <a href="https://docs.google.com/spreadsheets/d/1R1eskQhOAQqpVILrBfb3QId5KUroEztPQ6WAzTIL4rQ/edit"
                           target="_blank" class="view-all-btn">
                            View All in Google Sheets
                        </a>
                    </div>
                    <div class="vin-list-header">
                        <div>VIN</div>
                        <div>Vehicle</div>
                        <div>Year</div>
                        <div>Stock #</div>
                    </div>
                    <div class="vin-list">
                        ${vins.map(v => `
                            <div class="vin-item">
                                <div class="vin-number">${v.vin}</div>
                                <div class="vin-vehicle">${v.make || 'Unknown'} ${v.model || ''}</div>
                                <div class="vin-year">${v.year || '-'}</div>
                                <div class="vin-stock">${v.stock || '-'}</div>
                            </div>
                        `).join('')}
                        ${row.count > 5 ? `
                            <div class="vin-item" style="justify-content: center; color: #888;">
                                <em>... and ${(row.count - 5).toLocaleString()} more vehicles. Click "View All" to see complete list.</em>
                            </div>
                        ` : ''}
                    </div>
                `;
            }, 300);
        }

        function generateSampleVins(row) {
            // Generate placeholder VINs for combinations without sample data
            const samples = [];
            for (let i = 0; i < Math.min(5, row.count); i++) {
                samples.push({
                    vin: `Sample VIN ${i+1}`,
                    make: row.cdk ? 'Various' : 'Unknown',
                    model: '',
                    year: '2024',
                    stock: `STK${1000+i}`
                });
            }
            return samples;
        }

        function renderCharts() {
            // Source Chart
            new Chart(document.getElementById('sourceChart'), {
                type: 'bar',
                data: {
                    labels: ['CDK', 'vAuto', 'LoJack', 'OEM', 'FloorPlan'],
                    datasets: [{
                        label: 'Vehicles',
                        data: [22922, 19468, 27981, 1386, 8775],
                        backgroundColor: [
                            'rgba(0, 212, 255, 0.7)',
                            'rgba(0, 255, 136, 0.7)',
                            'rgba(255, 170, 0, 0.7)',
                            'rgba(168, 85, 247, 0.7)',
                            'rgba(255, 107, 107, 0.7)'
                        ],
                        borderWidth: 0,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#a0a0a0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#a0a0a0' }
                        }
                    }
                }
            });

            // Priority Chart
            new Chart(document.getElementById('priorityChart'), {
                type: 'doughnut',
                data: {
                    labels: ['P1 Critical', 'P2 High', 'P3 Medium', 'P4 OK/Review'],
                    datasets: [{
                        data: [4689, 18905, 3093, 16779],
                        backgroundColor: [
                            'rgba(255, 71, 87, 0.8)',
                            'rgba(255, 170, 0, 0.8)',
                            'rgba(0, 212, 255, 0.8)',
                            'rgba(100, 100, 100, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#ffffff', padding: 15 }
                        }
                    }
                }
            });
        }

        async function refreshDashboard() {
            const btn = document.getElementById('refreshBtn');
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="animation: spin 1s linear infinite;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg> Refreshing...';
            try {
                await fetch('https://us-central1-sonorous-key-320714.cloudfunctions.net/refresh-vin-dashboard');
                updateTimestamp();
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Done!';
                setTimeout(() => {
                    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg> Refresh';
                }, 2000);
            } catch (e) {
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg> Refresh';
            }
        }
    </script>
    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
</body>
</html>
